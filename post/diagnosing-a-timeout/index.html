<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.82.1"><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><link rel=manifest href=/favicon/site.webmanifest><link rel=mask-icon href=/favicon/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Diagnosing a Timeout: From Customer Reports through a Completed Root Cause Analysis - barbuzzi.dev</title><meta name=author content="dbarbuzzi"><meta name=description content="The journey of a customer-reported timeout error through developer review, investigation, profiling, and the resulting root cause analysis."><meta name=keywords content="debugging,profiling"><meta property="og:title" content="Diagnosing a Timeout: From Customer Reports through a Completed Root Cause Analysis"><meta name=twitter:title content="Diagnosing a Timeout: From Customer Reports through a Completed Root Cause Analysis"><meta property="og:type" content="article"><meta property="og:url" content="https://barbuzzi.dev/post/diagnosing-a-timeout/"><meta property="og:description" content="The journey of a customer-reported timeout error through developer review, investigation, profiling, and the resulting root cause analysis."><meta name=twitter:description content="The journey of a customer-reported timeout error through developer review, investigation, profiling, and the resulting root cause analysis."><meta name=twitter:card content="summary"><meta property="article:published_time" content="2021-04-22T16:43:46-04:00"><meta property="article:modified_time" content="2021-04-22T16:43:46-04:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://barbuzzi.dev/assets/css/fuji.min.css></head><body data-theme=auto><script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');fujiThemeData?fujiThemeData!=='auto'&&document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light'):localStorage.setItem('fuji_data-theme','auto')</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://barbuzzi.dev/>barbuzzi.dev</a></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><article><h2 class="post-item post-title"><a href=https://barbuzzi.dev/post/diagnosing-a-timeout/>Diagnosing a Timeout: From Customer Reports through a Completed Root Cause Analysis</a></h2><div class="post-item post-meta"><span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-04-22</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;1166 words</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href=/tags/debugging>debugging</a>&nbsp;<a href=/tags/profiling>profiling</a>&nbsp;</span></div><div class="post-content markdown-body"><blockquote><p>The journey of a customer-reported timeout error through developer review, investigation, profiling, and the resulting root cause analysis.</p></blockquote><h2 id=deciphering-the-issue>Deciphering the Issue</h2><p>Over a relatively short period of time, our customer support team had escalated a few “download issues” to JIRA tickets (individually): the short claim was that a few customers were reporting they were unable to download their products after purchase. The tickets were unfortunately bare-bones: mostly a few short words from the support member stating there was a problem with the order’s download and a reference to the case in Salesforce where the supporter was helping the customer. As our team was typically responsible for handling general customer support issues, we created a ‘discovery’ ticket in our backlog to look into these reported issues – validate they were consistent, determine if they were in fact the same issue or separate issues, and find the root cause(s).</p><p>What didn&rsquo;t make sense at first was that the customer support tools were able to view and download these orders without issue and those tools used the same packaging and download process as the customer-facing UI. Reading through the actual exchanges with customers and looking at a screenshot that one customer provided (showing our Cloudflare page for a 504/Gateway Timeout error), it became clear that while the customers’ were complaining about the download, the problem itself was that the order details page was not loading correctly (where the customer could review the completed order and, importantly, download its contents). The discovery ticket was revised with a clearer definition of the actual issue the customers were facing and it brought into our next sprint.</p><h2 id=initial-investigation>Initial Investigation</h2><p>Now believing that the tickets were likely to have a common root cause, my first step was to view each order in an attempt to find commonalities. Upon looking at them, one likely candidate was that each order contained a higher-than-average number of SKUs/products.</p><p>This problem had only started occurring somewhat recently but it was hard to pinpoint the date as the only details we had were based around customer support requests. Additionally, based on those messages and some testing, it was not specific to new “large” orders, but was also affecting past orders which previously had no issues with their respective “order details” page being loaded.</p><p>At this stage, I had a reasonably robust collection of data about the issue:</p><ul><li>It manifested as a timeout (>60 seconds to complete per our configs)</li><li>Common factor(s) included the number of SKUs/products in an order</li><li>It affected past orders that were previously fine in addition to new orders</li><li>Some customers that reported the issue had multiple orders but the issue only affected their “large” orders, not all of their orders</li><li>All affected orders could still be viewed successfully in customer support’s tools</li></ul><p>With this information, I decided that my next steps would be to profile the “order details” page that our customers would be taken to after completing an order to see what was going on.</p><h2 id=background-about-the-site-and-codebase>Background About the Site and Codebase</h2><p>At this point, some additional context about our site and codebase is relevant:</p><ul><li>The main codebase is a PHP-based legacy monolith with roots dating back more than 20 years</li><li>We have a local Docker environment that can be used for most development/feature testing efforts</li><li>We recently updated from PHP5 to PHP7 and the changes to the local environment resulted in Xdebug no longer being enabled for debugging by default</li><li>There are multiple teams/squads working on this site; some devs are using PhpStorm, some Visual Studio Code, and others using their own preferred editors.</li></ul><h2 id=profiling-the-order-details-page>Profiling the “Order Details” Page</h2><p>Looking at available PHP profiling tools, I settled on <a href=https://xdebug.org/ target=_blank>Xdebug</a> as a first attempt. While our environment no longer had Xdebug automatically set up for debugging, I had previously done work to be able to enable it manually as well as documented how to do so for others (and wrote a ticket for the work to update the environment to simplify the process).</p><p>Fortunately, configuring Xdebug for profiling was very similar to what was needed for debugging – just a few config changes and a special way of loading the page. After making and testing these environment changes (and documenting everything for future use by myself and others), I gathered a few sets of profiles of the problem “order details” page: an order with a single SKU, an order with a few SKUs that would still successfully load, and an order with enough SKUs that the timeout error would be triggered.</p><h2 id=analyzing-the-results>Analyzing the Results</h2><p>Now that profiles had been gathered, it was time to analyze the results. I had not been using PhpStorm thus far and I wanted to do things in a way that were repeatable to those also not using PhpStorm so I chose <a href=https://github.com/jokkedk/webgrind target=_blank>Webgrind</a> and loaded it via its Docker container.</p><p>Once I had the profiles loaded in Webgrind, it became trivial to find the issue. Looking at one of the datasets, I could immediately see that more than 85% of the processing time was spent in dozens of SQL queries:</p><figure><img src=/post-images/diagnosing-a-timeout-ss-topview.png><figcaption><h4>Top view of profiling results showing 85.70% of processing time used by SQL queries</h4></figcaption></figure><p>As I narrowed things down, a pattern emerged—there was one particular method making a query which had an execution count matching the number of SKUs in the order which was taking up almost all of the ~85% of SQL queries:</p><figure><img src=/post-images/diagnosing-a-timeout-ss-intermediate.png><figcaption><h4>Narrowed view of profiling results revealing a suspicious method</h4></figcaption></figure><p>With another click in this view I was able to identify the file and line number where that method was being called:</p><figure><img src=/post-images/diagnosing-a-timeout-ss-culprit.png><figcaption><h4>Narrowed view of profiling results revealing the file and line where the suspicious method was being called</h4></figcaption></figure><p>Now that I had a precise location, I opened my editor to look more closely at the code and git history. I could see that the method definition and this particular invocation were both added in the last few months. Some brief testing revealed that the query within the method, which looked up data for a single SKU, could take 5+ seconds. As it was executed once for each SKU in the order, any order with around 10-12 SKUs could result in the total processing time exceeding our configured 60-second timeout limit.</p><h2 id=resolution>Resolution</h2><p>Over the course of this investigation, I had accumulated various documentation:</p><ul><li>Further details about the issue</li><li>Profiling data from the investigation (with screenshots of relevant ares)</li><li>The problem’s root cause discovered</li><li>Steps required to profile and how to view the profile result data</li></ul><p>I was now ready to write the ticket for the work to resolve the issue. This query had been added by a different team and internal politics dictated that the ticket was written in their backlog outlining the issue and its root cause. Fortunately, they were able to take it on in their next sprint and solve it by retrieving the same information the query was providing in a way that was more readily available which, in turn, eliminated the previously added performance/timeout problem.</p></div></article></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/dbarbuzzi target=_blank><span>GitHub</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/debugging/>debugging</a></span>
<span><a href=/tags/profiling/>profiling</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#deciphering-the-issue>Deciphering the Issue</a></li><li><a href=#initial-investigation>Initial Investigation</a></li><li><a href=#background-about-the-site-and-codebase>Background About the Site and Codebase</a></li><li><a href=#profiling-the-order-details-page>Profiling the “Order Details” Page</a></li><li><a href=#analyzing-the-results>Analyzing the Results</a></li><li><a href=#resolution>Resolution</a></li></ul></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul><li><a href=https://github.com/dbarbuzzi target=_blank><span>GitHub</span></a></li></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div><span><a href=/tags/debugging/>debugging</a></span>
<span><a href=/tags/profiling/>profiling</a></span></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#deciphering-the-issue>Deciphering the Issue</a></li><li><a href=#initial-investigation>Initial Investigation</a></li><li><a href=#background-about-the-site-and-codebase>Background About the Site and Codebase</a></li><li><a href=#profiling-the-order-details-page>Profiling the “Order Details” Page</a></li><li><a href=#analyzing-the-results>Analyzing the Results</a></li><li><a href=#resolution>Resolution</a></li></ul></nav></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2020-2021
<a href=https://barbuzzi.dev/>dbarbuzzi</a>
| Powered by <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.0/lazysizes.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script><script defer src=/assets/js/fuji.min.js></script></body></html>